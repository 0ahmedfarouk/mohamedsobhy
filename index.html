<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>امتحان — Mr. Mohamed Sobhy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#070A1A; --bg2:#0D1B3A; --ring:#FFFFFF24; }
    *{ -webkit-tap-highlight-color: transparent; }
    body{margin:0;color:#fff;background:radial-gradient(1200px 700px at 70% -10%, #123 0%, transparent 60%), linear-gradient(135deg,var(--bg1),var(--bg2));font-family:Cairo, system-ui; -webkit-touch-callout:none; }
    .allow-select{ -webkit-user-select:text; user-select:text; }
    .input{ background:#fff; color:#111; caret-color:#111; border-radius:12px; }
    .wrap{max-width:1180px;margin:auto;padding:16px}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid var(--ring);backdrop-filter: blur(10px)}
    .logo{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.08)}
    iframe{width:100%;min-height:720px;border:0;border-radius:14px;background:#fff}
    @media (max-width:640px){ iframe{ min-height: 86vh; } }
    .hidden{display:none} .muted{opacity:.82}
    .iframe-wrap{border-radius:14px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:#071226;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);max-width:560px;width:95%}
    .small{font-size:13px;color:#cfd8ff}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);font-weight:700}
    .btn-primary{background:#8ab4ff;color:#00162a;border:none}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    #softToast{position:fixed;left:16px;right:16px;bottom:16px;background:#0b1937;color:#dbe6ff;border:1px solid #2a3b6b;padding:12px 14px;border-radius:12px;z-index:80;box-shadow:0 6px 24px rgba(0,0,0,.4);text-align:center;font-weight:700;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="glass rounded-2xl px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="logo.png" class="logo" alt="Mr. Mohamed Sobhy"/>
        <div>
          <div class="text-lg md:text-2xl font-extrabold">Mr. Mohamed Sobhy</div>
          <div class="muted text-xs md:text-sm">Arabic Language • الصف الثالث الثانوي</div>
        </div>
      </div>
      <div class="text-right">
        <div class="muted text-[11px] md:text-xs">الوقت المتبقي</div>
        <div id="timerMain" class="text-lg md:text-2xl" style="color:#8ab4ff;font-weight:800">--:--:--</div>
      </div>
    </header>

    <section id="welcome" class="mt-4 glass rounded-2xl p-4 md:p-6">
      <div class="flex items-start gap-4 flex-wrap">
        <div class="max-w-[720px]">
          <div style="display:inline-block;background:linear-gradient(90deg,#8ab4ff,#78a9ff);color:#00162a;font-weight:800;padding:8px 14px;border-radius:12px">مرحبًا بطلاب 3 ثانوي</div>
          <h1 class="text-xl md:text-2xl" style="margin-top:10px;font-weight:800">امتحان اللغة العربية بإشراف <span style="color:#8ab4ff">Mr. Mohamed Sobhy</span></h1>
          <p class="muted mt-2">أدخل الـ ID وكلمة المرور، واضغط <b>ابدأ الامتحان</b> لبدء المؤقت (<b>ساعتين</b>). على الموبايل: الخروج من التطبيق أو التبديل يسبب تحذير.</p>
          <div class="mt-3 actions items-center">
            <input id="sid" placeholder="ID (مثال: Farouk)" class="allow-select input px-3 py-3 text-black w-56" autocomplete="off"/>
            <input id="spw" placeholder="كلمة المرور" type="password" class="allow-select input px-3 py-3 text-black w-56" autocomplete="off"/>
            <button id="startBtn" class="btn btn-primary" onclick="startExam()">ابدأ الامتحان</button>
            <button id="infoBtn" class="btn" onclick="showInfo()">إرشادات</button>
          </div>
        </div>
      </div>
    </section>

    <section id="exam" class="hidden mt-4 glass rounded-2xl p-4 md:p-5">
      <div class="flex justify-between items-center gap-2 flex-wrap">
        <div>
          <div class="font-extrabold">امتحان اللغة العربية — <span style="color:#8ab4ff">Mr. Mohamed Sobhy</span></div>
          <div id="studentLabel" class="muted text-sm">الطالب: —</div>
        </div>
        <div class="text-right">
          <div class="muted text-xs">الوقت المتبقي</div>
          <div id="timerTop" style="color:#8ab4ff;font-weight:800">--:--:--</div>
        </div>
      </div>

      <div class="muted text-sm mt-2">تأكد من الضغط على <b>إرسال</b> داخل نموذج Google عند الانتهاء.</div>

      <div class="iframe-wrap mt-3">
        <iframe id="gform" src="" allow="clipboard-read; clipboard-write"></iframe>
      </div>

      <div class="actions mt-3 justify-between items-center">
        <div class="muted">التحذيرات: <span id="warns">0</span> / 3</div>
        <div class="actions">
          <button id="redoBtn" class="btn" onclick="openRedoModal()">طلب إعادة (Redo)</button>
          <button id="submitEnd" class="btn" onclick="endNow()">إنهاء الآن</button>
          <button id="logout" class="btn" onclick="logout()">تسجيل خروج</button>
        </div>
      </div>
    </section>

    <section id="locked" class="hidden mt-4 glass rounded-2xl p-6 text-center">
      <h2 style="font-weight:800">تم قفل الامتحان</h2>
      <p class="muted">انتهى الوقت أو تم تجاوز عدد التحذيرات. تواصل مع المدرس: <b>Mr. Mohamed Sobhy</b></p>
      <div class="mt-3">
        <button id="lockedRedoBtn" class="btn btn-primary" onclick="openRedoModal()">طلب إعادة من المدرس</button>
      </div>
    </section>

    <footer class="mt-4 text-center opacity-80">© <span id="year"></span> Mr. Mohamed Sobhy — Arabic Language</footer>
  </div>

  <!-- REDO modal (ID + باسورد الطالب + باسورد الريدو) -->
  <div id="modal" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="redoTitle">
    <div class="modal">
      <h3 id="redoTitle" style="margin:0 0 8px;font-weight:800">إدخال بيانات الريدو</h3>
      <p class="muted" style="margin:0 0 10px">ادخل ID الطالب + كلمة مرور الطالب + كلمة مرور الريدو من المستر.</p>
      <div class="flex flex-col gap-2">
        <input id="redoId" class="allow-select input px-3 py-2" placeholder="ID الطالب" autocomplete="off"/>
        <input id="redoPwStudent" class="allow-select input px-3 py-2" type="password" placeholder="كلمة مرور الطالب" autocomplete="off"/>
        <input id="redoPw" class="allow-select input px-3 py-2" type="password" placeholder="كلمة مرور الريدو (المستر)" autocomplete="off"/>
        <label class="small flex items-center gap-1">
          <input id="pwToggle" type="checkbox" /> إظهار كلمات المرور
        </label>
      </div>
      <div class="actions justify-end">
        <button id="modalCancel" class="btn" onclick="closeModal()">إلغاء</button>
        <button id="modalOk" class="btn btn-primary" onclick="verifyRedo()">تحقق</button>
      </div>
      <p class="small mt-2">لو اتحققت بنجاح هتتفتح جلسة جديدة ويتم إعادة ضبط المؤقت.</p>
    </div>
  </div>

  <!-- WARNING modal -->
  <div id="warnModal" class="modal-bg" role="alertdialog" aria-modal="true" aria-labelledby="warnTitle">
    <div class="modal">
      <h3 id="warnTitle" style="margin:0 0 6px;font-weight:800">⚠️ تحذير رقم <span id="warnNo">1</span> / 3</h3>
      <p id="warnMsg" class="muted" style="margin:0 0 10px">تم رصد محاولة قد تُعتبر غشًا.</p>
      <ul class="small" style="margin:0 0 10px;line-height:1.7">
        <li>ممنوع الخروج من التطبيق/التبويب أثناء الامتحان (الموبايل يشمل التنقل بين التطبيقات).</li>
        <li>ممنوع فتح أدوات المطوّر أو الاختصارات المشابهة.</li>
        <li>النسخ ممنوع — لكن <b>اللصق مسموح</b> لو عندك مسودّة.</li>
      </ul>
      <div class="actions justify-end">
        <button id="warnOk" class="btn btn-primary">موافق</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="softToast"></div>

<script>
/* ===================== الإعدادات ===================== */
const GFORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSd-KaIDtPRra4Ixa-sl70FUIFXuxQ-buS-zt_TLmJ-bHlwLHg/viewform?embedded=true";
const DURATION = 2 * 60 * 60; // ساعتين
const WARN_LIMIT = 3;
const REDO_PASSWORD = "admin9redo";
const UNBAN_PASSWORD = "admin9unban";   // كلمة فكّ الحظر النهائي
const BLOCK_URL = "block.html";         // صفحة الحظر

/* الطلاب */
const STUDENTS = {"Farouk":"Farouk273","Shady":"Shady441","Mostafa":"Mostafa562","Lina":"Lina834","Rokaya":"Rokaya199","Menna":"Menna482","Zad":"Zad901","7oda":"7oda317","Moaz":"Moaz652","Menna2":"Menna745","Dalen":"Dalen209","Jana":"Jana338","Somaya":"Somaya555","Roudina":"Roudina812","Malak":"Malak633","Omar1":"Omar441","Omar2":"Omar932","Sama":"Sama214","Roaa":"Roaa687"};

/* المحظورين (ID + نفس باسورد الطالب) */
const BANNED_CREDENTIALS = [
  ["Mostafa","Mostafa562"], // مصطفى
];

/* ===================== أدوات عامة ===================== */
const LS = { id:'ms_id', start:'ms_start', warns:'ms_warns', locked:'ms_locked', redo:'ms_redo', log:'ms_log', pending:'ms_pending_warns' };
const $ = (s)=>document.querySelector(s);
const now = ()=>Date.now();
const pad = (n)=>String(n).padStart(2,'0');
function fmt(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${pad(h)}:${pad(m)}:${pad(s)}`; }
function setWarn(n){ localStorage.setItem(LS.warns,String(n)); $('#warns').textContent=n; }
function getWarn(){ return parseInt(localStorage.getItem(LS.warns)||"0",10); }
function show(id){ ['welcome','exam','locked'].forEach(x=>$('#'+x).classList.add('hidden')); $('#'+id).classList.remove('hidden'); }
function lock(){ localStorage.setItem(LS.locked,'1'); log('LOCK'); show('locked'); }
function log(ev){ const arr = JSON.parse(localStorage.getItem(LS.log)||"[]"); arr.push({t:new Date().toISOString(), ev}); localStorage.setItem(LS.log, JSON.stringify(arr)); }
function toast(msg){ const el = document.getElementById('softToast'); el.textContent = msg; el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',3000); }

$('#year').textContent = new Date().getFullYear();

/* ===================== بصمة الجهاز + قفل نهائي ===================== */
// بصمة بسيطة: UA + Platform + لغات + دقة الشاشة + عمق الألوان + المنطقة الزمنية + عدد الأنوية إن وُجد
function deviceFingerprint(){
  const nav = window.navigator;
  const parts = [
    nav.userAgent || '',
    nav.platform || '',
    (nav.languages || []).join(','),
    screen.width+'x'+screen.height,
    String(screen.colorDepth || ''),
    String(new Date().getTimezoneOffset()),
    String(nav.hardwareConcurrency || ''),
  ].join('||');
  // هاش بسيط
  let hash=0; for(let i=0;i<parts.length;i++){ hash=((hash<<5)-hash)+parts.charCodeAt(i); hash|=0; }
  return String(hash);
}
const FP = deviceFingerprint();

function isBannedCredential(id,pw){ return BANNED_CREDENTIALS.some(([x,y])=>x===id&&y===pw); }

function setPermanentBan(){
  // خزّن البصمة في أكثر من مكان احتياطيًا
  try{
    localStorage.setItem('permBanHash', FP);
    sessionStorage.setItem('permBanHash', FP);
  }catch(e){}
}

function clearPermanentBan(){
  try{
    localStorage.removeItem('permBanHash');
    sessionStorage.removeItem('permBanHash');
  }catch(e){}
}

function checkPermanentBanAndRedirect(){
  try{
    const ls = localStorage.getItem('permBanHash');
    const ss = sessionStorage.getItem('permBanHash');
    if(ls===FP || ss===FP){
      window.location.href = BLOCK_URL;
    }
  }catch(e){}
}
checkPermanentBanAndRedirect();

/* ===================== استرجاع الحالة ===================== */
(function restore(){
  if(localStorage.getItem(LS.locked)==='1'){ show('locked'); return; }
  const pend = parseInt(localStorage.getItem(LS.pending)||'0',10);
  if(pend>0){
    setWarn(getWarn()+pend);
    localStorage.setItem(LS.pending,'0');
    toast(`تم تسجيل ${pend} تحذير بسبب مغادرة/إعادة تحميل الصفحة.`);
    if(getWarn()>=WARN_LIMIT){ lock(); return; }
  }
  const sid = localStorage.getItem(LS.id);
  const st = parseInt(localStorage.getItem(LS.start)||"0",10);
  if(sid && st && (now() - st) < DURATION*1000){
    openExam(sid, st); setWarn(getWarn());
  } else {
    ['id','start','warns'].forEach(k=>localStorage.removeItem(LS[k]));
    show('welcome');
  }
})();

/* ===================== المؤقّت ===================== */
let interval=null;
function startTimer(startAt){
  function tick(){
    const elapsed = Math.floor((now()-startAt)/1000);
    const left = Math.max(0, DURATION - elapsed);
    const t = fmt(left);
    $('#timerMain').textContent = t; $('#timerTop').textContent = t;
    if(left<=0){ toast('انتهى وقت الامتحان. سيتم قفل الصفحة.'); lock(); clearInterval(interval); }
  }
  tick(); interval=setInterval(tick,1000);
}

/* ===================== Tap helpers ===================== */
function addTap(id, fn){
  const el = typeof id==='string' ? $(id) : id;
  if(!el) return;
  el.addEventListener('click', fn, {passive:true});
  el.addEventListener('touchend', (e)=>{ e.preventDefault(); fn(e); }, {passive:false});
}

/* ===================== بدء / إرشادات ===================== */
function startExam(){
  const sid = $('#sid').value.trim(); const pw  = $('#spw').value.trim();
  if(!sid || !pw) return toast('اكتب الـ ID وكلمة المرور');

  // فكّ الحظر النهائي بالباسورد الخاص
  if(pw === UNBAN_PASSWORD){
    clearPermanentBan();
    toast('تم رفع الحظر عن هذا الجهاز.');
    return;
  }

  // لو الطالب محظور → فعّل القفل النهائي + تحويل لصفحة الحظر
  if(isBannedCredential(sid, pw)){
    setPermanentBan();
    window.location.href = BLOCK_URL;
    return;
  }

  if(!(sid in STUDENTS) || STUDENTS[sid] !== pw) return toast('بيانات الدخول غير صحيحة');

  const startAt = now();
  localStorage.setItem(LS.id, sid);
  localStorage.setItem(LS.start, String(startAt));
  localStorage.setItem(LS.warns, "0");
  localStorage.setItem(LS.redo, "0");
  localStorage.setItem(LS.pending, "0");
  log('LOGIN:'+sid); openExam(sid, startAt);
}
function showInfo(){ toast('التعليمات: مدة الامتحان ساعتين — الخروج = تحذير — ٣ تحذيرات ويُقفل — النسخ ممنوع، اللصق مسموح.'); }

/* ===================== فتح الامتحان ===================== */
function openExam(sid, startAt){
  $('#studentLabel').textContent = `الطالب: ${sid} (${sid})`;
  $('#gform').src = GFORM_URL;
  show('exam'); startTimer(startAt); guards();
}

/* ===================== مودال التحذير ===================== */
function openWarnModal(text, n){
  $('#warnNo').textContent = String(n);
  $('#warnMsg').textContent = text + ' — من فضلك ابقَ داخل صفحة الامتحان واتّبع القواعد.';
  const wm = $('#warnModal'); wm.style.display='flex';
  return new Promise((resolve)=>{
    const handler = ()=>{ wm.style.display='none'; $('#warnOk').removeEventListener('click', handler); resolve(); };
    $('#warnOk').addEventListener('click', handler, {once:true});
  });
}
async function addWarn(kind){
  let n = getWarn()+1; setWarn(n);
  await openWarnModal(kind, n);
  if(n>=WARN_LIMIT){ toast('تم تجاوز الحد من التحذيرات.'); lock(); }
}
/* تحذير صامت (reload/close) */
function bumpWarnSilent(kind){
  setWarn(getWarn()+1);
  log('WARN_SILENT:'+kind);
}

/* ===================== الحماية ===================== */
function guards(){
  window.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});
  window.addEventListener('copy', e=>{ e.preventDefault(); addWarn('نسخ محتوى'); }, {passive:false});
  window.addEventListener('keydown', e=>{
    if (e.key === 'F12' || ((e.ctrlKey||e.metaKey) && e.shiftKey && ['I','C','J'].includes(e.key))) {
      e.preventDefault(); addWarn('محاولة فتح أدوات المطور');
    }
  }, {passive:false});

  function hidden(){ log('HIDE'); addWarn('الخروج من التطبيق/التبويب'); }
  function shown(){ log('SHOW'); }

  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) hidden(); else shown(); });

  window.addEventListener('pagehide', ()=>{
    bumpWarnSilent('pagehide');
    const pend = parseInt(localStorage.getItem(LS.pending)||'0',10);
    localStorage.setItem(LS.pending, String(pend + 1));
  });

  window.addEventListener('beforeunload', (e)=>{
    if($('#exam') && !$('#exam').classList.contains('hidden')){
      bumpWarnSilent('beforeunload');
      const pend = parseInt(localStorage.getItem(LS.pending)||'0',10);
      localStorage.setItem(LS.pending, String(pend + 1));
      e.preventDefault(); e.returnValue='';
    }
  });
}

/* ===================== REDO (يتحقق من 3 خانات) ===================== */
function openRedoModal(){ const modal = $('#modal'); if(!modal) return; modal.style.display = 'flex'; syncPwShow(); $('#redoId').focus(); }
function closeModal(){ const modal=$('#modal'); if(modal){ modal.style.display='none'; } }
function syncPwShow(){
  const show = $('#pwToggle')?.checked;
  if($('#redoPwStudent')) $('#redoPwStudent').type = show ? 'text' : 'password';
  if($('#redoPw')) $('#redoPw').type = show ? 'text' : 'password';
}
document.getElementById('pwToggle')?.addEventListener('change', syncPwShow);

function verifyRedo(){
  const id  = ($('#redoId').value || '').trim();
  const spw = ($('#redoPwStudent').value || '').trim();
  const rpw = ($('#redoPw').value || '').trim();

  if(!id || !spw || !rpw) return toast('من فضلك أدخل كل البيانات.');
  if(!(id in STUDENTS) || STUDENTS[id] !== spw) return toast('بيانات الطالب غير صحيحة.');

  // لو محظور → قفل نهائي + تحويل
  if(isBannedCredential(id, spw)){
    setPermanentBan();
    window.location.href = BLOCK_URL;
    return;
  }

  if(rpw !== REDO_PASSWORD) return toast('كلمة مرور الريدو غير صحيحة.');

  // نجاح: تصفير المؤقت وفتح جلسة جديدة
  localStorage.setItem(LS.locked, '0');
  const nowt = now(); localStorage.setItem(LS.start, String(nowt));
  localStorage.setItem(LS.redo, String(parseInt(localStorage.getItem(LS.redo)||'0')+1));
  localStorage.setItem(LS.id, id);
  openExam(id, nowt);
  closeModal(); toast('تم تفعيل الريدو — المؤقت اتصفر.');
}
addTap('#modalOk', verifyRedo);
addTap('#modalCancel', closeModal);
addTap('#lockedRedoBtn', openRedoModal);
addTap('#redoBtn', openRedoModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

/* ===================== إنهاء / خروج ===================== */
function endNow(){
  if(confirm('هل تريد إنهاء الامتحان الآن؟ تأكد من الضغط على "إرسال" داخل نموذج Google أولاً.')){
    localStorage.removeItem(LS.id); localStorage.removeItem(LS.start); localStorage.removeItem(LS.warns); localStorage.removeItem(LS.pending);
    log('END_NOW'); show('welcome');
  }
}
function logout(){
  if(confirm('تسجيل خروج سيُنهي الجلسة. متأكد؟')){
    localStorage.removeItem(LS.id); localStorage.removeItem(LS.start); localStorage.removeItem(LS.warns); localStorage.removeItem(LS.pending);
    log('LOGOUT'); show('welcome');
  }
}
addTap('#submitEnd', endNow);
addTap('#logout', logout);

/* كشف الحظر النهائي كل مرة */
checkPermanentBanAndRedirect();

window.startExam = startExam;
window.showInfo = showInfo;
window.openRedoModal = openRedoModal;
window.endNow = endNow;
window.logout = logout;
</script>
</body>
</html>
