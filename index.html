<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>امتحان — Mr. Mohamed Sobhy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#070A1A; --bg2:#0D1B3A; --ring:#FFFFFF24; }
    *{ -webkit-tap-highlight-color: transparent; }
    body{margin:0;color:#fff;background:radial-gradient(1200px 700px at 70% -10%, #123 0%, transparent 60%), linear-gradient(135deg,var(--bg1),var(--bg2));font-family:Cairo, system-ui; -webkit-touch-callout:none; }
    .allow-select{ -webkit-user-select:text; user-select:text; }
    .input{ background:#fff; color:#111; caret-color:#111; border-radius:12px; }
    .wrap{max-width:1180px;margin:auto;padding:16px}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid var(--ring);backdrop-filter: blur(10px)}
    .logo{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.08)}
    iframe{width:100%;min-height:720px;border:0;border-radius:14px;background:#fff}
    @media (max-width:640px){ iframe{ min-height: 86vh; } }
    .hidden{display:none} .muted{opacity:.82}
    .iframe-wrap{border-radius:14px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:#071226;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);max-width:560px;width:95%}
    .small{font-size:13px;color:#cfd8ff}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);font-weight:700}
    .btn-primary{background:#8ab4ff;color:#00162a;border:none}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="glass rounded-2xl px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="logo.png" class="logo" alt="Mr. Mohamed Sobhy"/>
        <div>
          <div class="text-lg md:text-2xl font-extrabold">Mr. Mohamed Sobhy</div>
          <div class="muted text-xs md:text-sm">Arabic Language • الصف الثالث الثانوي</div>
        </div>
      </div>
      <div class="text-right">
        <div class="muted text-[11px] md:text-xs">الوقت المتبقي</div>
        <div id="timerMain" class="text-lg md:text-2xl" style="color:#8ab4ff;font-weight:800">--:--:--</div>
      </div>
    </header>

    <section id="welcome" class="mt-4 glass rounded-2xl p-4 md:p-6">
      <div class="flex items-start gap-4 flex-wrap">
        <div class="max-w-[720px]">
          <div style="display:inline-block;background:linear-gradient(90deg,#8ab4ff,#78a9ff);color:#00162a;font-weight:800;padding:8px 14px;border-radius:12px">مرحبًا بطلاب 3 ثانوي</div>
          <h1 class="text-xl md:text-2xl" style="margin-top:10px;font-weight:800">امتحان اللغة العربية بإشراف <span style="color:#8ab4ff">Mr. Mohamed Sobhy</span></h1>
          <p class="muted mt-2">أدخل الـ ID وكلمة المرور، واضغط <b>ابدأ الامتحان</b> لبدء المؤقت (<b>ساعتين</b>). على الموبايل: الخروج من التطبيق أو التبديل يسبب تحذير.</p>
          <div class="mt-3 actions items-center">
            <input id="sid" placeholder="ID (مثال: Farouk)" class="allow-select input px-3 py-3 text-black w-56" autocomplete="off"/>
            <input id="spw" placeholder="كلمة المرور" type="password" class="allow-select input px-3 py-3 text-black w-56" autocomplete="off"/>
            <button id="startBtn" class="btn btn-primary" onclick="startExam()">ابدأ الامتحان</button>
            <button id="infoBtn" class="btn" onclick="showInfo()">إرشادات</button>
          </div>
        </div>
      </div>
    </section>

    <section id="exam" class="hidden mt-4 glass rounded-2xl p-4 md:p-5">
      <div class="flex justify-between items-center gap-2 flex-wrap">
        <div>
          <div class="font-extrabold">امتحان اللغة العربية — <span style="color:#8ab4ff">Mr. Mohamed Sobhy</span></div>
          <div id="studentLabel" class="muted text-sm">الطالب: —</div>
        </div>
        <div class="text-right">
          <div class="muted text-xs">الوقت المتبقي</div>
          <div id="timerTop" style="color:#8ab4ff;font-weight:800">--:--:--</div>
        </div>
      </div>

      <div class="muted text-sm mt-2">تأكد من الضغط على <b>إرسال</b> داخل نموذج Google عند الانتهاء.</div>

      <div class="iframe-wrap mt-3">
        <iframe id="gform" src="" allow="clipboard-read; clipboard-write"></iframe>
      </div>

      <div class="actions mt-3 justify-between items-center">
        <div class="muted">التحذيرات: <span id="warns">0</span> / 3</div>
        <div class="actions">
          <button id="redoBtn" class="btn" onclick="openRedoModal()">طلب إعادة (Redo)</button>
          <button id="submitEnd" class="btn" onclick="endNow()">إنهاء الآن</button>
          <button id="logout" class="btn" onclick="logout()">تسجيل خروج</button>
        </div>
      </div>
    </section>

    <section id="locked" class="hidden mt-4 glass rounded-2xl p-6 text-center">
      <h2 style="font-weight:800">تم قفل الامتحان</h2>
      <p class="muted">انتهى الوقت أو تم تجاوز عدد التحذيرات. تواصل مع المدرس: <b>Mr. Mohamed Sobhy</b></p>
      <div class="mt-3">
        <button id="lockedRedoBtn" class="btn btn-primary" onclick="openRedoModal()">طلب إعادة من المدرس</button>
      </div>
    </section>

    <footer class="mt-4 text-center opacity-80">© <span id="year"></span> Mr. Mohamed Sobhy — Arabic Language</footer>
  </div>

  <!-- REDO modal -->
  <div id="modal" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="redoTitle">
    <div class="modal">
      <h3 id="redoTitle" style="margin:0 0 8px;font-weight:800">إدخال كلمة مرور الريدو</h3>
      <p class="muted" style="margin:0 0 10px">عشان تعمل ريدو يا غشّاش 😄 — خَلّي المستر يديك كلمة مرور الريدو وادخلها هنا.</p>
      <div class="flex gap-2 items-center">
        <input id="redoPw" class="allow-select input" type="password" placeholder="كلمة مرور المدرس للريدو" style="flex:1;padding:10px;margin-bottom:8px" dir="ltr" autocomplete="off"/>
        <label class="small flex items-center gap-1" style="margin-bottom:8px">
          <input id="pwToggle" type="checkbox" /> إظهار
        </label>
      </div>
      <div class="actions justify-end">
        <button id="modalCancel" class="btn" onclick="closeModal()">إلغاء</button>
        <button id="modalOk" class="btn btn-primary" onclick="verifyRedo()">تحقق</button>
      </div>
      <p class="small mt-2">لو اتحققت بنجاح هتتفتح جلسة جديدة ويتم إعادة ضبط المؤقت.</p>
    </div>
  </div>

  <!-- WARNING modal -->
  <div id="warnModal" class="modal-bg" role="alertdialog" aria-modal="true" aria-labelledby="warnTitle">
    <div class="modal">
      <h3 id="warnTitle" style="margin:0 0 6px;font-weight:800">⚠️ تحذير رقم <span id="warnNo">1</span> / 3</h3>
      <p id="warnMsg" class="muted" style="margin:0 0 10px">تم رصد محاولة قد تُعتبر غشًا.</p>
      <ul class="small" style="margin:0 0 10px;line-height:1.7">
        <li>ممنوع الخروج من التطبيق/التبويب أثناء الامتحان (الموبايل يشمل التنقل بين التطبيقات).</li>
        <li>ممنوع فتح أدوات المطوّر أو الاختصارات المشابهة.</li>
        <li>النسخ ممنوع — لكن <b>اللصق مسموح</b> لو عندك مسودّة.</li>
      </ul>
      <div class="actions justify-end">
        <button id="warnOk" class="btn btn-primary">موافق</button>
      </div>
    </div>
  </div>

<script>
/* =================== الإعدادات =================== */
const GFORM_URL   = "https://docs.google.com/forms/d/e/1FAIpQLSd-KaIDtPRra4Ixa-sl70FUIFXuxQ-buS-zt_TLmJ-bHlwLHg/viewform?embedded=true";
const DURATION    = 2 * 60 * 60;   // ساعتان
const WARN_LIMIT  = 3;
const REDO_PASSWORD = "admin9redo";
const STUDENTS = {"Farouk":"Farouk273","Shady":"Shady441","Mostafa":"Mostafa562","Lina":"Lina834","Rokaya":"Rokaya199","Menna":"Menna482","Zad":"Zad901","7oda":"7oda317","Moaz":"Moaz652","Menna2":"Menna745","Dalen":"Dalen209","Jana":"Jana338","Somaya":"Somaya555","Roudina":"Roudina812","Malak":"Malak633","Omar1":"Omar441","Omar2":"Omar932","Sama":"Sama214","Roaa":"Roaa687"};

const LS = { id:'ms_id', start:'ms_start', warns:'ms_warns', locked:'ms_locked', redo:'ms_redo', log:'ms_log' };
const $   = (s)=>document.querySelector(s);
const now = ()=>Date.now();
const pad = (n)=>String(n).padStart(2,'0');
function fmt(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${pad(h)}:${pad(m)}:${pad(s)}`; }
function setWarn(n){ localStorage.setItem(LS.warns,String(n)); $('#warns').textContent=n; }
function getWarn(){ return parseInt(localStorage.getItem(LS.warns)||"0",10); }
function show(id){ ['welcome','exam','locked'].forEach(x=>$('#'+x).classList.add('hidden')); $('#'+id).classList.remove('hidden'); }
function lock(){ localStorage.setItem(LS.locked,'1'); log('LOCK'); show('locked'); }
function log(ev){ const arr = JSON.parse(localStorage.getItem(LS.log)||"[]"); arr.push({t:new Date().toISOString(), ev}); localStorage.setItem(LS.log, JSON.stringify(arr)); }

$('#year').textContent = new Date().getFullYear();

/* ======= منع الإنذار الكاذب عند فتح الكيبورد (Android/iOS) ======= */
let _vvh = (window.visualViewport?.height || window.innerHeight);
let _lastTapTs = 0;
let _keyboardOpen = false;
let _kbTimer = null;
function _markTapInsideForm(){ _lastTapTs = Date.now(); }
function _watchViewportResize(){
  const h = (window.visualViewport?.height || window.innerHeight);
  const delta = _vvh - h;   // موجب = تقلص الارتفاع (غالبًا كيبورد)
  _vvh = h;
  if (delta > 120 && (Date.now() - _lastTapTs) < 800) {
    _keyboardOpen = true;
    clearTimeout(_kbTimer);
    _kbTimer = setTimeout(()=>{ _keyboardOpen = false; }, 1200);
  }
}
window.addEventListener('resize', _watchViewportResize, {passive:true});
if (window.visualViewport){
  window.visualViewport.addEventListener('resize', _watchViewportResize, {passive:true});
}

/* =================== استعادة الجلسة =================== */
(function restore(){
  if(localStorage.getItem(LS.locked)==='1'){ show('locked'); return; }
  const sid = localStorage.getItem(LS.id);
  const st  = parseInt(localStorage.getItem(LS.start)||"0",10);
  if(sid && st && (now() - st) < DURATION*1000){ openExam(sid, st); setWarn(getWarn()); }
  else { ['id','start','warns'].forEach(k=>localStorage.removeItem(LS[k])); show('welcome'); }
})();

/* =================== المؤقت =================== */
let interval=null;
function startTimer(startAt){
  function tick(){
    const elapsed = Math.floor((now()-startAt)/1000);
    const left = Math.max(0, DURATION - elapsed);
    const t = fmt(left);
    $('#timerMain').textContent = t; $('#timerTop').textContent = t;
    if(left<=0){ alert('انتهى وقت الامتحان. سيتم قفل الصفحة.'); lock(); clearInterval(interval); }
  }
  tick(); interval=setInterval(tick,1000);
}

/* =================== لمسات موبايل =================== */
function addTap(id, fn){
  const el = typeof id==='string' ? $(id) : id;
  if(!el) return;
  el.addEventListener('click', fn, {passive:true});
  el.addEventListener('touchend', (e)=>{ e.preventDefault(); fn(e); }, {passive:false});
}

/* =================== بدء / إرشادات =================== */
function startExam(){
  const sid = $('#sid').value.trim(); const pw = $('#spw').value.trim();
  if(!sid || !pw) return alert('اكتب الـ ID وكلمة المرور');
  if(!(sid in STUDENTS) || STUDENTS[sid] !== pw) return alert('بيانات الدخول غير صحيحة');
  const startAt = now(); localStorage.setItem(LS.id, sid); localStorage.setItem(LS.start, String(startAt)); localStorage.setItem(LS.warns, "0"); localStorage.setItem(LS.redo, "0");
  log('LOGIN:'+sid);
  openExam(sid, startAt);
}
function showInfo(){ alert('التعليمات:\n- مدة الامتحان ساعتين من لحظة البدء.\n- الخروج من التطبيق/التبويب = تحذير.\n- عند ٣ تحذيرات يتم القفل.\n- النسخ ممنوع، اللصق مسموح.'); }

/* =================== فتح صفحة الامتحان =================== */
function openExam(sid, startAt){
  $('#studentLabel').textContent = `الطالب: ${sid} (${sid})`;
  const frm = document.getElementById('gform');
  frm.src = GFORM_URL;
  // تسجيل اللمسة داخل الفورم لتمييز فتح الكيبورد
  ['pointerdown','touchstart','mousedown','focus'].forEach(ev=>{
    frm.addEventListener(ev, _markTapInsideForm, {passive:true});
  });
  show('exam'); startTimer(startAt); guards();
}

/* =================== منع الغش =================== */
function guards(){
  // منع القائمة اليمنى والنسخ (اللصق مسموح افتراضيًا داخل الفورم)
  window.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});
  window.addEventListener('copy', e=>{ e.preventDefault(); addWarn('نسخ محتوى'); }, {passive:false});
  window.addEventListener('keydown', e=>{
    if (e.key === 'F12' || ((e.ctrlKey||e.metaKey) && e.shiftKey && ['I','C','J'].includes(e.key))) {
      e.preventDefault(); addWarn('محاولة فتح أدوات المطور');
    }
  }, {passive:false});

  function hidden(){
    // تجاهل الخروج لو الكيبورد لسه مفتوح بعد لمس داخل الفورم
    if (_keyboardOpen) return;
    log('HIDE');
    addWarn('الخروج من التطبيق/التبويب');
    try{ location.reload(); }catch{}
  }
  function shown(){ log('SHOW'); }

  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) hidden(); else shown(); });
  window.addEventListener('pagehide', hidden);
  window.addEventListener('blur', ()=>{ if(/Mobi|Android|iPhone/i.test(navigator.userAgent)) hidden(); });
  window.addEventListener('focus', shown);

  window.addEventListener('beforeunload', (e)=>{ if($('#exam') && !$('#exam').classList.contains('hidden')){ e.preventDefault(); e.returnValue=''; } });
}

/* =================== نافذة التحذير =================== */
function openWarnModal(text, n){
  $('#warnNo').textContent = String(n);
  $('#warnMsg').textContent = text + ' — من فضلك ابقَ داخل صفحة الامتحان واتّبع القواعد.';
  const wm = $('#warnModal'); wm.style.display='flex';
  return new Promise((resolve)=>{
    const handler = ()=>{ wm.style.display='none'; $('#warnOk').removeEventListener('click', handler); resolve(); };
    $('#warnOk').addEventListener('click', handler, {once:true});
  });
}
async function addWarn(kind){
  let n = getWarn()+1; setWarn(n);
  await openWarnModal(kind, n);
  if(n>=WARN_LIMIT){ alert('تم تجاوز الحد من التحذيرات. سيتم قفل الصفحة.'); lock(); }
}

/* =================== الريدو =================== */
function openRedoModal(){ const modal = $('#modal'); if(!modal) return; modal.style.display = 'flex'; $('#redoPw').type = $('#pwToggle').checked ? 'text' : 'password'; $('#redoPw').focus(); }
function closeModal(){ const modal=$('#modal'); if(modal){ modal.style.display='none'; } $('#redoPw').value=''; }
function verifyRedo(){
  const val = ($('#redoPw').value || '').trim();
  if(val === REDO_PASSWORD){
    localStorage.setItem(LS.locked, '0'); localStorage.setItem(LS.warns, "0");
    const nowt = now(); localStorage.setItem(LS.start, String(nowt));
    localStorage.setItem(LS.redo, String(parseInt(localStorage.getItem(LS.redo)||'0')+1));
    const sid = localStorage.getItem(LS.id) || prompt('أدخل ID الطالب:');
    if(sid){ localStorage.setItem(LS.id, sid); openExam(sid, nowt); }
    closeModal();
    alert('تم تفعيل الريدو — المؤقت اتصفر والنموذج اتعمله إعادة تحميل.');
  } else {
    alert('كلمة المرور غير صحيحة. اطلبها من المدرس.');
  }
}
addTap('#modalOk', verifyRedo);
addTap('#modalCancel', closeModal);
addTap('#lockedRedoBtn', openRedoModal);
addTap('#redoBtn', openRedoModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
$('#pwToggle').addEventListener('change', (e)=>{ $('#redoPw').type = e.target.checked ? 'text' : 'password'; });

/* =================== إنهاء وخروج =================== */
function endNow(){
  if(confirm('هل تريد إنهاء الامتحان الآن؟ تأكد من الضغط على "إرسال" داخل نموذج Google أولاً.')){
    localStorage.removeItem(LS.id); localStorage.removeItem(LS.start); localStorage.removeItem(LS.warns);
    log('END_NOW'); show('welcome');
  }
}
function logout(){
  if(confirm('تسجيل خروج سيُنهي الجلسة. متأكد؟')){
    localStorage.removeItem(LS.id); localStorage.removeItem(LS.start); localStorage.removeItem(LS.warns);
    log('LOGOUT'); show('welcome');
  }
}
addTap('#submitEnd', endNow);
addTap('#logout', logout);

/* للتصريح للدوال من HTML */
window.startExam = startExam;
window.showInfo = showInfo;
window.openRedoModal = openRedoModal;
window.endNow = endNow;
window.logout = logout;
</script>
</body>
</html>
