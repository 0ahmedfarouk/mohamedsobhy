<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>امتحان — Mr. Mohamed Sobhy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#070A1A; --bg2:#0D1B3A; --ring:#FFFFFF24; }
    body{margin:0;color:#fff;background:radial-gradient(1200px 700px at 70% -10%, #123 0%, transparent 60%), linear-gradient(135deg,var(--bg1),var(--bg2));font-family:Cairo, system-ui}
    .wrap{max-width:1180px;margin:auto;padding:20px}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid var(--ring);backdrop-filter: blur(10px)}
    .logo{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.08)}
    iframe{width:100%;min-height:720px;border:0;border-radius:14px;background:#fff}
    .hidden{display:none} .muted{opacity:.8}
    .iframe-wrap{border-radius:14px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:#071226;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);max-width:560px;width:95%}
    .small{font-size:13px;color:#cfd8ff}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.12)}
    .btn-primary{background:#8ab4ff;color:#00162a;font-weight:800;border:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="glass rounded-2xl px-5 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img src="logo.png" class="logo" alt="Mr. Mohamed Sobhy"/>
        <div>
          <div class="text-xl md:text-2xl font-extrabold">Mr. Mohamed Sobhy</div>
          <div class="muted text-sm">Arabic Language • الصف الثالث الثانوي</div>
        </div>
      </div>
      <div class="text-right">
        <div class="muted text-xs">الوقت المتبقي</div>
        <div id="timerMain" class="text-lg md:text-2xl" style="color:#8ab4ff;font-weight:800">--:--:--</div>
      </div>
    </header>

    <section id="welcome" class="mt-5 glass rounded-2xl p-6">
      <div class="flex items-start gap-6 flex-wrap">
        <div class="max-w-[720px]">
          <div style="display:inline-block;background:linear-gradient(90deg,#8ab4ff,#78a9ff);color:#00162a;font-weight:800;padding:8px 14px;border-radius:12px">مرحبًا بطلاب 3 ثانوي</div>
          <h1 style="font-size:24px;margin-top:10px;font-weight:800">امتحان اللغة العربية بإشراف <span style="color:#8ab4ff">Mr. Mohamed Sobhy</span></h1>
          <p class="muted" style="margin-top:8px">أدخل الـ ID وكلمة المرور المرسلة لك، واضغط <b>ابدأ الامتحان</b> لبدء المؤقت (٤ ساعات). بعد الإرسال يمكنك طلب إعادة (Redo) من المدرس بكلمة سر.</p>
          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <input id="sid" placeholder="ID (مثال: Farouk)" class="px-3 py-2 rounded-xl text-black w-56"/>
            <input id="spw" placeholder="كلمة المرور" type="password" class="px-3 py-2 rounded-xl text-black w-56"/>
            <button id="startBtn" class="px-4 py-3 rounded-xl" style="background:#8ab4ff;color:#00162a;font-weight:800">ابدأ الامتحان</button>
            <button id="infoBtn" class="px-4 py-3 rounded-xl border border-white/10">إرشادات</button>
          </div>
        </div>
      </div>
    </section>

    <section id="exam" class="hidden mt-5 glass rounded-2xl p-5">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:800">امتحان اللغة العربية — <span style="color:#8ab4ff">Mr. Mohamed Sobhy</span></div>
          <div id="studentLabel" class="muted text-sm">الطالب: —</div>
        </div>
        <div class="text-right">
          <div class="muted text-xs">الوقت المتبقي</div>
          <div id="timerTop" style="color:#8ab4ff;font-weight:800">--:--:--</div>
        </div>
      </div>

      <div class="muted text-sm mt-2">تأكد من الضغط على <b>إرسال</b> داخل نموذج Google عند الانتهاء.</div>

      <div class="iframe-wrap" style="margin-top:12px">
        <iframe id="gform" src="" allow="clipboard-read; clipboard-write"></iframe>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="muted">التحذيرات: <span id="warns">0</span> / 3</div>
        <div style="display:flex;gap:8px">
          <button id="redoBtn" onclick="openRedoModal()" class="btn">طلب إعادة (Redo)</button>
          <button id="submitEnd" class="btn">إنهاء الآن</button>
          <button id="logout" class="btn">تسجيل خروج</button>
        </div>
      </div>
    </section>

    <section id="locked" class="hidden mt-5 glass rounded-2xl p-6 text-center">
      <h2 style="font-weight:800">تم قفل الامتحان</h2>
      <p class="muted">انتهى الوقت أو تم تجاوز عدد التحذيرات. تواصل مع المدرس: <b>Mr. Mohamed Sobhy</b></p>
      <div style="margin-top:12px">
        <button id="lockedRedoBtn" onclick="openRedoModal()" class="btn btn-primary">طلب إعادة من المدرس</button>
      </div>
    </section>

    <footer style="margin-top:18px;text-align:center;opacity:.8">© <span id="year"></span> Mr. Mohamed Sobhy — Arabic Language</footer>
  </div>

  <!-- REDO modal -->
  <div id="modal" class="modal-bg">
    <div class="modal">
      <h3 style="margin:0 0 8px;font-weight:800">إدخال كلمة مرور الريدو</h3>
      <p class="muted" style="margin:0 0 10px">عشان تعمل ريدو يا غشّاش 😄 — خَلّي المستر يديك كلمة مرور الريدو وادخلها هنا.</p>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="redoPw" type="password" placeholder="كلمة مرور المدرس للريدو" style="flex:1;padding:10px;border-radius:8px;margin-bottom:8px"/>
        <label class="small" style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
          <input id="pwToggle" type="checkbox"/> إظهار
        </label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="modalCancel" class="btn">إلغاء</button>
        <button id="modalOk" class="btn btn-primary">تحقق</button>
      </div>
      <p class="small" style="margin-top:10px">لو اتحققت بنجاح هتتفتح جلسة جديدة ويتم إعادة ضبط المؤقت.</p>
    </div>
  </div>

  <!-- WARNING modal -->
  <div id="warnModal" class="modal-bg">
    <div class="modal">
      <h3 style="margin:0 0 6px;font-weight:800">⚠️ تحذير رقم <span id="warnNo">1</span> / 3</h3>
      <p id="warnMsg" class="muted" style="margin:0 0 10px">تم رصد محاولة قد تُعتبر غشًا.</p>
      <ul class="small" style="margin:0 0 10px;line-height:1.7">
        <li>ممنوع الخروج من التبويب أثناء الامتحان.</li>
        <li>ممنوع فتح أدوات المطوّر أو الاختصارات المشابهة.</li>
        <li>النسخ ممنوع — لكن <b>اللصق مسموح</b> لو عندك مسودّة.</li>
      </ul>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="warnOk" class="btn btn-primary">موافق</button>
      </div>
    </div>
  </div>

<script>
const GFORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdaZkgN2c4xPntdhFkXXnO_NDINgC4qHA-FxddH49eCuhkUMw/viewform?embedded=true";
const DURATION = 4 * 60 * 60;
const WARN_LIMIT = 3;
const REDO_PASSWORD = "admin9redo";
const STUDENTS = {"Farouk":"Farouk273","Shady":"Shady441","Mostafa":"Mostafa562","Lina":"Lina834","Rokaya":"Rokaya199","Menna":"Menna482","Zad":"Zad901","7oda":"7oda317","Moaz":"Moaz652","Menna2":"Menna745","Dalen":"Dalen209","Jana":"Jana338","Somaya":"Somaya555","Roudina":"Roudina812","Malak":"Malak633","Omar1":"Omar441","Omar2":"Omar932","Sama":"Sama214","Roaa":"Roaa687"};

const LS = { id:'ms_id', start:'ms_start', warns:'ms_warns', locked:'ms_locked', redo:'ms_redo' };
const $ = (s)=>document.querySelector(s);
const now = ()=>Date.now();
const pad = (n)=>String(n).padStart(2,'0');
function fmt(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${pad(h)}:${pad(m)}:${pad(s)}`; }
function setWarn(n){ localStorage.setItem(LS.warns,String(n)); $('#warns').textContent=n; }
function getWarn(){ return parseInt(localStorage.getItem(LS.warns)||"0",10); }
function show(id){ ['welcome','exam','locked'].forEach(x=>$('#'+x).classList.add('hidden')); $('#'+id).classList.remove('hidden'); }
function lock(){ localStorage.setItem(LS.locked,'1'); show('locked'); }

$('#year').textContent = new Date().getFullYear();

(function restore(){
  if(localStorage.getItem(LS.locked)==='1'){ show('locked'); return; }
  const sid = localStorage.getItem(LS.id);
  const st = parseInt(localStorage.getItem(LS.start)||"0",10);
  if(sid && st && (now() - st) < DURATION*1000){ openExam(sid, st); setWarn(getWarn()); } else { ['id','start','warns'].forEach(k=>localStorage.removeItem(LS[k])); show('welcome'); }
})();

let interval=null;
function startTimer(startAt){
  function tick(){
    const elapsed = Math.floor((now()-startAt)/1000);
    const left = Math.max(0, DURATION - elapsed);
    const t = fmt(left);
    $('#timerMain').textContent = t; $('#timerTop').textContent = t;
    if(left<=0){ alert('انتهى وقت الامتحان. سيتم قفل الصفحة.'); lock(); clearInterval(interval); }
  }
  tick(); interval=setInterval(tick,1000);
}

// ===== Start/Login =====
$('#startBtn').addEventListener('click', ()=>{
  const sid = $('#sid').value.trim(); const pw  = $('#spw').value.trim();
  if(!sid || !pw) return alert('اكتب الـ ID وكلمة المرور');
  if(!(sid in STUDENTS) || STUDENTS[sid] !== pw) return alert('بيانات الدخول غير صحيحة');
  const startAt = now(); localStorage.setItem(LS.id, sid); localStorage.setItem(LS.start, String(startAt)); localStorage.setItem(LS.warns, "0"); localStorage.setItem(LS.redo, "0");
  openExam(sid, startAt);
});

$('#infoBtn').addEventListener('click', ()=>{ alert('التعليمات:\\n- مدة الامتحان ٤ ساعات من لحظة البدء.\\n- الخروج من التبويب = تحذير.\\n- عند ٣ تحذيرات يتم القفل.\\n- النسخ ممنوع، اللصق مسموح.'); });

$('#submitEnd').addEventListener('click', ()=>{ if(confirm('هل تريد إنهاء الامتحان الآن؟ تأكد من الضغط على "إرسال" داخل نموذج Google أولاً.')){ localStorage.removeItem(LS.id); localStorage.removeItem(LS.start); localStorage.removeItem(LS.warns); alert('تم إنهاء جلستك. بالتوفيق!'); show('welcome'); } });

$('#logout').addEventListener('click', ()=>{ if(confirm('تسجيل خروج سيُنهي الجلسة. متأكد؟')){ localStorage.removeItem(LS.id); localStorage.removeItem(LS.start); localStorage.removeItem(LS.warns); show('welcome'); } });

// ===== Exam open =====
function openExam(sid, startAt){ $('#studentLabel').textContent = `الطالب: ${sid} (${sid})`; $('#gform').src = GFORM_URL; show('exam'); startTimer(startAt); guards(); }

// ===== Anti-cheat: allow paste, block copy =====
function guards(){
  window.addEventListener('contextmenu', e=>e.preventDefault());
  // Allow paste, block copy only
  window.addEventListener('copy', e=>{ e.preventDefault(); addWarn('نسخ محتوى'); });
  // Devtools shortcuts
  window.addEventListener('keydown', e=>{
    if (e.key === 'F12' || ((e.ctrlKey||e.metaKey) && e.shiftKey && ['I','C','J'].includes(e.key))) { e.preventDefault(); addWarn('محاولة فتح أدوات المطور'); }
  });
  // Leaving tab
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ addWarn('الخروج من التبويب'); try{ location.reload(); }catch(_){} } });
  // before unload confirm
  window.addEventListener('beforeunload', (e)=>{ if($('#exam') && !$('#exam').classList.contains('hidden')){ e.preventDefault(); e.returnValue=''; } });
}

// ===== Warnings with modal =====
function openWarnModal(text, n){
  $('#warnNo').textContent = String(n);
  $('#warnMsg').textContent = text + ' — من فضلك ابقَ داخل صفحة الامتحان واتّبع القواعد.';
  const wm = $('#warnModal'); wm.style.display='flex';
  return new Promise((resolve)=>{
    const handler = ()=>{ wm.style.display='none'; $('#warnOk').removeEventListener('click', handler); resolve(); };
    $('#warnOk').addEventListener('click', handler);
  });
}

async function addWarn(kind){
  let n = getWarn()+1; setWarn(n);
  await openWarnModal(kind, n);
  if(n>=WARN_LIMIT){ alert('تم تجاوز الحد من التحذيرات. سيتم قفل الصفحة.'); lock(); }
}

// ===== REDO =====
function openRedoModal(){ const modal = $('#modal'); if(!modal) return; modal.style.display = 'flex'; }
window.openRedoModal = openRedoModal;
$('#pwToggle').addEventListener('change', (e)=>{ $('#redoPw').type = e.target.checked ? 'text' : 'password'; });
$('#modalCancel').addEventListener('click', ()=>{ const modal=$('#modal'); if(modal){ modal.style.display='none'; } $('#redoPw').value=''; });
$('#modalOk').addEventListener('click', ()=>{
  const val = ($('#redoPw').value || '').trim();
  if(val === REDO_PASSWORD){
    localStorage.setItem(LS.locked, '0'); localStorage.setItem(LS.warns, "0");
    const nowt = now(); localStorage.setItem(LS.start, String(nowt));
    localStorage.setItem(LS.redo, String(parseInt(localStorage.getItem(LS.redo)||'0')+1));
    const sid = localStorage.getItem(LS.id) || prompt('أدخل ID الطالب:');
    if(sid){ localStorage.setItem(LS.id, sid); openExam(sid, nowt); }
    const modal=$('#modal'); if(modal){ modal.style.display='none'; } $('#redoPw').value='';
    alert('تم تفعيل الريدو — المؤقت اتصفر والنموذج اتعمله إعادة تحميل.');
  } else {
    alert('كلمة المرور غير صحيحة. اطلبها من المدرس.');
  }
});

// Esc to close modals
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ const m1=$('#modal'); const m2=$('#warnModal'); if(m1) m1.style.display='none'; if(m2) m2.style.display='none'; } });
</script>
</body>
</html>
