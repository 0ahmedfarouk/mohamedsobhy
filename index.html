<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Ø§Ù…ØªØ­Ø§Ù† â€” Mr. Mohamed Sobhy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg1:#070A1A; --bg2:#0D1B3A; --ring:#FFFFFF24; }
    *{ -webkit-tap-highlight-color: transparent; }
    body{margin:0;color:#fff;background:radial-gradient(1200px 700px at 70% -10%, #123 0%, transparent 60%), linear-gradient(135deg,var(--bg1),var(--bg2));font-family:Cairo, system-ui; -webkit-touch-callout:none; }
    .allow-select{ -webkit-user-select:text; user-select:text; }
    .input{ background:#fff; color:#111; caret-color:#111; border-radius:12px; }
    .wrap{max-width:1180px;margin:auto;padding:16px}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));border:1px solid var(--ring);backdrop-filter: blur(10px)}
    .logo{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.08)}
    iframe{width:100%;min-height:720px;border:0;border-radius:14px;background:#fff}
    @media (max-width:640px){ iframe{ min-height: 86vh; } }
    .hidden{display:none} .muted{opacity:.82}
    .iframe-wrap{border-radius:14px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:#071226;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);max-width:560px;width:95%}
    .small{font-size:13px;color:#cfd8ff}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);font-weight:700}
    .btn-primary{background:#8ab4ff;color:#00162a;border:none}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="glass rounded-2xl px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="logo.png" class="logo" alt="Mr. Mohamed Sobhy"/>
        <div>
          <div class="text-lg md:text-2xl font-extrabold">Mr. Mohamed Sobhy</div>
          <div class="muted text-xs md:text-sm">Arabic Language â€¢ Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</div>
        </div>
      </div>
      <div class="text-right">
        <div class="muted text-[11px] md:text-xs">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
        <div id="timerMain" class="text-lg md:text-2xl" style="color:#8ab4ff;font-weight:800">--:--:--</div>
      </div>
    </header>

    <section id="welcome" class="mt-4 glass rounded-2xl p-4 md:p-6">
      <div class="flex items-start gap-4 flex-wrap">
        <div class="max-w-[720px]">
          <div style="display:inline-block;background:linear-gradient(90deg,#8ab4ff,#78a9ff);color:#00162a;font-weight:800;padding:8px 14px;border-radius:12px">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ø·Ù„Ø§Ø¨ 3 Ø«Ø§Ù†ÙˆÙŠ</div>
          <h1 class="text-xl md:text-2xl" style="margin-top:10px;font-weight:800">Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø¥Ø´Ø±Ø§Ù <span style="color:#8ab4ff">Mr. Mohamed Sobhy</span></h1>
          <p class="muted mt-2">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ ID ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ ÙˆØ§Ø¶ØºØ· <b>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</b> Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª (<b>Ø³Ø§Ø¹ØªÙŠÙ†</b>). Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙŠØ³Ø¨Ø¨ ØªØ­Ø°ÙŠØ±.</p>
          <div class="mt-3 actions items-center">
            <input id="sid" placeholder="ID (Ù…Ø«Ø§Ù„: Farouk)" class="allow-select input px-3 py-3 text-black w-56" autocomplete="off"/>
            <input id="spw" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password" class="allow-select input px-3 py-3 text-black w-56" autocomplete="off"/>
            <button id="startBtn" class="btn btn-primary" onclick="startExam()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
            <button id="infoBtn" class="btn" onclick="showInfo()">Ø¥Ø±Ø´Ø§Ø¯Ø§Øª</button>
          </div>
        </div>
      </div>
    </section>

    <section id="exam" class="hidden mt-4 glass rounded-2xl p-4 md:p-5">
      <div class="flex justify-between items-center gap-2 flex-wrap">
        <div>
          <div class="font-extrabold">Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© â€” <span style="color:#8ab4ff">Mr. Mohamed Sobhy</span></div>
          <div id="studentLabel" class="muted text-sm">Ø§Ù„Ø·Ø§Ù„Ø¨: â€”</div>
        </div>
        <div class="text-right">
          <div class="muted text-xs">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
          <div id="timerTop" style="color:#8ab4ff;font-weight:800">--:--:--</div>
        </div>
      </div>

      <div class="muted text-sm mt-2">ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ <b>Ø¥Ø±Ø³Ø§Ù„</b> Ø¯Ø§Ø®Ù„ Ù†Ù…ÙˆØ°Ø¬ Google Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.</div>

      <div class="iframe-wrap mt-3">
        <iframe id="gform" src="" allow="clipboard-read; clipboard-write"></iframe>
      </div>

      <div class="actions mt-3 justify-between items-center">
        <div class="muted">Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª: <span id="warns">0</span> / 3</div>
        <div class="actions">
          <button id="redoBtn" class="btn" onclick="openRedoModal()">Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© (Redo)</button>
          <button id="submitEnd" class="btn" onclick="endNow()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>
          <button id="logout" class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
    </section>

    <section id="locked" class="hidden mt-4 glass rounded-2xl p-6 text-center">
      <h2 style="font-weight:800">ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h2>
      <p class="muted">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø£Ùˆ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³: <b>Mr. Mohamed Sobhy</b></p>
      <div class="mt-3">
        <button id="lockedRedoBtn" class="btn btn-primary" onclick="openRedoModal()">Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³</button>
      </div>
    </section>

    <footer class="mt-4 text-center opacity-80">Â© <span id="year"></span> Mr. Mohamed Sobhy â€” Arabic Language</footer>
  </div>

  <!-- REDO modal -->
  <div id="modal" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="redoTitle">
    <div class="modal">
      <h3 id="redoTitle" style="margin:0 0 8px;font-weight:800">Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø±ÙŠØ¯Ùˆ</h3>
      <p class="muted" style="margin:0 0 10px">Ø¹Ø´Ø§Ù† ØªØ¹Ù…Ù„ Ø±ÙŠØ¯Ùˆ ÙŠØ§ ØºØ´Ù‘Ø§Ø´ ğŸ˜„ â€” Ø®ÙÙ„Ù‘ÙŠ Ø§Ù„Ù…Ø³ØªØ± ÙŠØ¯ÙŠÙƒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø±ÙŠØ¯Ùˆ ÙˆØ§Ø¯Ø®Ù„Ù‡Ø§ Ù‡Ù†Ø§.</p>
      <div class="flex gap-2 items-center">
        <input id="redoPw" class="allow-select input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯Ø±Ø³ Ù„Ù„Ø±ÙŠØ¯Ùˆ" style="flex:1;padding:10px;margin-bottom:8px" dir="ltr" autocomplete="off"/>
        <label class="small flex items-center gap-1" style="margin-bottom:8px">
          <input id="pwToggle" type="checkbox" /> Ø¥Ø¸Ù‡Ø§Ø±
        </label>
      </div>
      <div class="actions justify-end">
        <button id="modalCancel" class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="modalOk" class="btn btn-primary" onclick="verifyRedo()">ØªØ­Ù‚Ù‚</button>
      </div>
      <p class="small mt-2">Ù„Ùˆ Ø§ØªØ­Ù‚Ù‚Øª Ø¨Ù†Ø¬Ø§Ø­ Ù‡ØªØªÙØªØ­ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¤Ù‚Øª.</p>
    </div>
  </div>

  <!-- WARNING modal -->
  <div id="warnModal" class="modal-bg" role="alertdialog" aria-modal="true" aria-labelledby="warnTitle">
    <div class="modal">
      <h3 id="warnTitle" style="margin:0 0 6px;font-weight:800">âš ï¸ ØªØ­Ø°ÙŠØ± Ø±Ù‚Ù… <span id="warnNo">1</span> / 3</h3>
      <p id="warnMsg" class="muted" style="margin:0 0 10px">ØªÙ… Ø±ØµØ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø¯ ØªÙØ¹ØªØ¨Ø± ØºØ´Ù‹Ø§.</p>
      <ul class="small" style="margin:0 0 10px;line-height:1.7">
        <li>Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚/Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠØ´Ù…Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª).</li>
        <li>Ù…Ù…Ù†ÙˆØ¹ ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± Ø£Ùˆ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡Ø©.</li>
        <li>Ø§Ù„Ù†Ø³Ø® Ù…Ù…Ù†ÙˆØ¹ â€” Ù„ÙƒÙ† <b>Ø§Ù„Ù„ØµÙ‚ Ù…Ø³Ù…ÙˆØ­</b> Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù…Ø³ÙˆØ¯Ù‘Ø©.</li>
      </ul>
      <div class="actions justify-end">
        <button id="warnOk" class="btn btn-primary">Ù…ÙˆØ§ÙÙ‚</button>
      </div>
    </div>
  </div>

<script>
/* =================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =================== */
const GFORM_URL   = "https://docs.google.com/forms/d/e/1FAIpQLSd-KaIDtPRra4Ixa-sl70FUIFXuxQ-buS-zt_TLmJ-bHlwLHg/viewform?embedded=true";
const DURATION    = 2 * 60 * 60;   // Ø³Ø§Ø¹ØªØ§Ù†
const WARN_LIMIT  = 3;
const REDO_PASSWORD = "admin9redo";
const STUDENTS = {"Farouk":"Farouk273","Shady":"Shady441","Mostafa":"Mostafa562","Lina":"Lina834","Rokaya":"Rokaya199","Menna":"Menna482","Zad":"Zad901","7oda":"7oda317","Moaz":"Moaz652","Menna2":"Menna745","Dalen":"Dalen209","Jana":"Jana338","Somaya":"Somaya555","Roudina":"Roudina812","Malak":"Malak633","Omar1":"Omar441","Omar2":"Omar932","Sama":"Sama214","Roaa":"Roaa687"};

const LS = { id:'ms_id', start:'ms_start', warns:'ms_warns', locked:'ms_locked', redo:'ms_redo', log:'ms_log' };
const $   = (s)=>document.querySelector(s);
const now = ()=>Date.now();
const pad = (n)=>String(n).padStart(2,'0');
function fmt(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${pad(h)}:${pad(m)}:${pad(s)}`; }
function setWarn(n){ localStorage.setItem(LS.warns,String(n)); $('#warns').textContent=n; }
function getWarn(){ return parseInt(localStorage.getItem(LS.warns)||"0",10); }
function show(id){ ['welcome','exam','locked'].forEach(x=>$('#'+x).classList.add('hidden')); $('#'+id).classList.remove('hidden'); }
function lock(){ localStorage.setItem(LS.locked,'1'); log('LOCK'); show('locked'); }
function log(ev){ const arr = JSON.parse(localStorage.getItem(LS.log)||"[]"); arr.push({t:new Date().toISOString(), ev}); localStorage.setItem(LS.log, JSON.stringify(arr)); }

$('#year').textContent = new Date().getFullYear();

/* ======= Ù…Ù†Ø¹ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„ÙƒØ§Ø°Ø¨ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (Android/iOS) ======= */
let _vvh = (window.visualViewport?.height || window.innerHeight);
let _lastTapTs = 0;
let _keyboardOpen = false;
let _kbTimer = null;
function _markTapInsideForm(){ _lastTapTs = Date.now(); }
function _watchViewportResize(){
  const h = (window.visualViewport?.height || window.innerHeight);
  const delta = _vvh - h;   // Ù…ÙˆØ¬Ø¨ = ØªÙ‚Ù„Øµ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (ØºØ§Ù„Ø¨Ù‹Ø§ ÙƒÙŠØ¨ÙˆØ±Ø¯)
  _vvh = h;
  if (delta > 120 && (Date.now() - _lastTapTs) < 800) {
    _keyboardOpen = true;
    clearTimeout(_kbTimer);
    _kbTimer = setTimeout(()=>{ _keyboardOpen = false; }, 1200);
  }
}
window.addEventListener('resize', _watchViewportResize, {passive:true});
if (window.visualViewport){
  window.visualViewport.addEventListener('resize', _watchViewportResize, {passive:true});
}

/* =================== Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© =================== */
(function restore(){
  if(localStorage.getItem(LS.locked)==='1'){ show('locked'); return; }
  const sid = localStorage.getItem(LS.id);
  const st  = parseInt(localStorage.getItem(LS.start)||"0",10);
  if(sid && st && (now() - st) < DURATION*1000){ openExam(sid, st); setWarn(getWarn()); }
  else { ['id','start','warns'].forEach(k=>localStorage.removeItem(LS[k])); show('welcome'); }
})();

/* =================== Ø§Ù„Ù…Ø¤Ù‚Øª =================== */
let interval=null;
function startTimer(startAt){
  function tick(){
    const elapsed = Math.floor((now()-startAt)/1000);
    const left = Math.max(0, DURATION - elapsed);
    const t = fmt(left);
    $('#timerMain').textContent = t; $('#timerTop').textContent = t;
    if(left<=0){ alert('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†. Ø³ÙŠØªÙ… Ù‚ÙÙ„ Ø§Ù„ØµÙØ­Ø©.'); lock(); clearInterval(interval); }
  }
  tick(); interval=setInterval(tick,1000);
}

/* =================== Ù„Ù…Ø³Ø§Øª Ù…ÙˆØ¨Ø§ÙŠÙ„ =================== */
function addTap(id, fn){
  const el = typeof id==='string' ? $(id) : id;
  if(!el) return;
  el.addEventListener('click', fn, {passive:true});
  el.addEventListener('touchend', (e)=>{ e.preventDefault(); fn(e); }, {passive:false});
}

/* =================== Ø¨Ø¯Ø¡ / Ø¥Ø±Ø´Ø§Ø¯Ø§Øª =================== */
function startExam(){
  const sid = $('#sid').value.trim(); const pw = $('#spw').value.trim();
  if(!sid || !pw) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ù€ ID ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  if(!(sid in STUDENTS) || STUDENTS[sid] !== pw) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
  const startAt = now(); localStorage.setItem(LS.id, sid); localStorage.setItem(LS.start, String(startAt)); localStorage.setItem(LS.warns, "0"); localStorage.setItem(LS.redo, "0");
  log('LOGIN:'+sid);
  openExam(sid, startAt);
}
function showInfo(){ alert('Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:\n- Ù…Ø¯Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø³Ø§Ø¹ØªÙŠÙ† Ù…Ù† Ù„Ø­Ø¸Ø© Ø§Ù„Ø¨Ø¯Ø¡.\n- Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚/Ø§Ù„ØªØ¨ÙˆÙŠØ¨ = ØªØ­Ø°ÙŠØ±.\n- Ø¹Ù†Ø¯ Ù£ ØªØ­Ø°ÙŠØ±Ø§Øª ÙŠØªÙ… Ø§Ù„Ù‚ÙÙ„.\n- Ø§Ù„Ù†Ø³Ø® Ù…Ù…Ù†ÙˆØ¹ØŒ Ø§Ù„Ù„ØµÙ‚ Ù…Ø³Ù…ÙˆØ­.'); }

/* =================== ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† =================== */
function openExam(sid, startAt){
  $('#studentLabel').textContent = `Ø§Ù„Ø·Ø§Ù„Ø¨: ${sid} (${sid})`;
  const frm = document.getElementById('gform');
  frm.src = GFORM_URL;
  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„Ù…Ø³Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙˆØ±Ù… Ù„ØªÙ…ÙŠÙŠØ² ÙØªØ­ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
  ['pointerdown','touchstart','mousedown','focus'].forEach(ev=>{
    frm.addEventListener(ev, _markTapInsideForm, {passive:true});
  });
  show('exam'); startTimer(startAt); guards();
}

/* =================== Ù…Ù†Ø¹ Ø§Ù„ØºØ´ =================== */
function guards(){
  // Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ ÙˆØ§Ù„Ù†Ø³Ø® (Ø§Ù„Ù„ØµÙ‚ Ù…Ø³Ù…ÙˆØ­ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙˆØ±Ù…)
  window.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});
  window.addEventListener('copy', e=>{ e.preventDefault(); addWarn('Ù†Ø³Ø® Ù…Ø­ØªÙˆÙ‰'); }, {passive:false});
  window.addEventListener('keydown', e=>{
    if (e.key === 'F12' || ((e.ctrlKey||e.metaKey) && e.shiftKey && ['I','C','J'].includes(e.key))) {
      e.preventDefault(); addWarn('Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±');
    }
  }, {passive:false});

  function hidden(){
    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ùˆ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù„Ø³Ù‡ Ù…ÙØªÙˆØ­ Ø¨Ø¹Ø¯ Ù„Ù…Ø³ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙÙˆØ±Ù…
    if (_keyboardOpen) return;
    log('HIDE');
    addWarn('Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚/Ø§Ù„ØªØ¨ÙˆÙŠØ¨');
    try{ location.reload(); }catch{}
  }
  function shown(){ log('SHOW'); }

  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) hidden(); else shown(); });
  window.addEventListener('pagehide', hidden);
  window.addEventListener('blur', ()=>{ if(/Mobi|Android|iPhone/i.test(navigator.userAgent)) hidden(); });
  window.addEventListener('focus', shown);

  window.addEventListener('beforeunload', (e)=>{ if($('#exam') && !$('#exam').classList.contains('hidden')){ e.preventDefault(); e.returnValue=''; } });
}

/* =================== Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± =================== */
function openWarnModal(text, n){
  $('#warnNo').textContent = String(n);
  $('#warnMsg').textContent = text + ' â€” Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¨Ù‚Ù Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§ØªÙ‘Ø¨Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯.';
  const wm = $('#warnModal'); wm.style.display='flex';
  return new Promise((resolve)=>{
    const handler = ()=>{ wm.style.display='none'; $('#warnOk').removeEventListener('click', handler); resolve(); };
    $('#warnOk').addEventListener('click', handler, {once:true});
  });
}
async function addWarn(kind){
  let n = getWarn()+1; setWarn(n);
  await openWarnModal(kind, n);
  if(n>=WARN_LIMIT){ alert('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ù…Ù† Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª. Ø³ÙŠØªÙ… Ù‚ÙÙ„ Ø§Ù„ØµÙØ­Ø©.'); lock(); }
}

/* =================== Ø§Ù„Ø±ÙŠØ¯Ùˆ =================== */
function openRedoModal(){ const modal = $('#modal'); if(!modal) return; modal.style.display = 'flex'; $('#redoPw').type = $('#pwToggle').checked ? 'text' : 'password'; $('#redoPw').focus(); }
function closeModal(){ const modal=$('#modal'); if(modal){ modal.style.display='none'; } $('#redoPw').value=''; }
function verifyRedo(){
  const val = ($('#redoPw').value || '').trim();
  if(val === REDO_PASSWORD){
    localStorage.setItem(LS.locked, '0'); localStorage.setItem(LS.warns, "0");
    const nowt = now(); localStorage.setItem(LS.start, String(nowt));
    localStorage.setItem(LS.redo, String(parseInt(localStorage.getItem(LS.redo)||'0')+1));
    const sid = localStorage.getItem(LS.id) || prompt('Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ø·Ø§Ù„Ø¨:');
    if(sid){ localStorage.setItem(LS.id, sid); openExam(sid, nowt); }
    closeModal();
    alert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±ÙŠØ¯Ùˆ â€” Ø§Ù„Ù…Ø¤Ù‚Øª Ø§ØªØµÙØ± ÙˆØ§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§ØªØ¹Ù…Ù„Ù‡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„.');
  } else {
    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ø·Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³.');
  }
}
addTap('#modalOk', verifyRedo);
addTap('#modalCancel', closeModal);
addTap('#lockedRedoBtn', openRedoModal);
addTap('#redoBtn', openRedoModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
$('#pwToggle').addEventListener('change', (e)=>{ $('#redoPw').type = e.target.checked ? 'text' : 'password'; });

/* =================== Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ®Ø±ÙˆØ¬ =================== */
function endNow(){
  if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¢Ù†ØŸ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø±Ø³Ø§Ù„" Ø¯Ø§Ø®Ù„ Ù†Ù…ÙˆØ°Ø¬ Google Ø£ÙˆÙ„Ø§Ù‹.')){
    localStorage.removeItem(LS.id); localStorage.removeItem(LS.start); localStorage.removeItem(LS.warns);
    log('END_NOW'); show('welcome');
  }
}
function logout(){
  if(confirm('ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø³ÙŠÙÙ†Ù‡ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©. Ù…ØªØ£ÙƒØ¯ØŸ')){
    localStorage.removeItem(LS.id); localStorage.removeItem(LS.start); localStorage.removeItem(LS.warns);
    log('LOGOUT'); show('welcome');
  }
}
addTap('#submitEnd', endNow);
addTap('#logout', logout);

/* Ù„Ù„ØªØµØ±ÙŠØ­ Ù„Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† HTML */
window.startExam = startExam;
window.showInfo = showInfo;
window.openRedoModal = openRedoModal;
window.endNow = endNow;
window.logout = logout;
</script>
</body>
</html>
